#!/bin/bash

# Constants
readonly WORKSPACE="GaeManda.xcworkspace"

# Variables
swiftlint_path=""
swiftlint_yml_path=""

# Find swiftlint path
path=$(find ~/ -name "$WORKSPACE" -print -quit 2>/dev/null)
if [ -n "$path" ]; then
  directory=$(dirname "$path")
  swiftlint_path="$directory/swiftlint"
  swiftlint_yml_path="$directory/.swiftlint.yml"
  if [ -e "$swiftlint_path" ] && [ -e "$swiftlint_yml_path" ]; then
    echo "âœ… $WORKSPACE íŒŒì¼ì´ ìˆëŠ” ë””ë ‰í† ë¦¬ì—ì„œ swiftlintê³¼ .swiftlint.ymlì„ ì°¾ì•˜ìŠµë‹ˆë‹¤."
    echo "âœ… [swiftlint] : $swiftlint_path"
    printf "âœ… [.swiftlint.yml] : $swiftlint_yml_path\n\n"
  else
    echo "âŒ $WORKSPACE íŒŒì¼ì´ ìˆëŠ” ë””ë ‰í† ë¦¬ì—ì„œ swiftlintê³¼ .swiftlint.ymlì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    exit 1
  fi
else
  echo "âŒ $WORKSPACE íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

# Check if swiftlint and .swiftlint.yml exist and are executable
printf "ğŸš€ swiftlint, .swiftlint.yml ì²´í¬ ì¤‘...\n\n"
if [ -n "$swiftlint_path" ] && [ -n "$swiftlint_yml_path" ] && [ -x "$swiftlint_path" ]; then
  printf "âœ… swiftlint, .swiftlint.yml ì²´í¬ ì„±ê³µ\n\n"
else
  echo "âŒ swiftlint, .swiftlint.yml ì²´í¬ ì‹¤íŒ¨."
  exit 1
fi

# Find Swift files to apply swiftlint to
changed_files=$(git diff --stat --cached)
upstream_branch=$(git for-each-ref --format='%(upstream:short)' $(git symbolic-ref -q HEAD)) 
swift_files=$(git diff --stat --cached --diff-filter=d --name-only $upstream_branch | grep -E "\.swift$")

if [ -n "$changed_files" ] && [ -z "$swift_files" ]; then
  echo "ğŸ™†ğŸ»â€â™‚ï¸ ì»¤ë°‹ ì„±ê³µ."
  exit 0
elif [ -z "$changed_files" ] || [ -z "$swift_files" ]; then
  echo "ğŸ™‹ğŸ»â€â™‚ï¸ ìŠ¤í…Œì´ì§• ì˜ì—­ì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

# Apply swiftlint
printf "ğŸš€ swiftlint ì ìš© ì¤‘...\n\n"
lint_result=$("$swiftlint_path" lint --quiet --config "$swiftlint_yml_path")
printf "âœ… swiftlint ì ìš© ì™„ë£Œ.\n\n"

if [ -z "$lint_result" ]; then
  echo "â¤ï¸  ì‘ì„±í•œ ì½”ë“œê°€ swiftlintì— ë§ìŠµë‹ˆë‹¤."
  echo "ğŸ™†ğŸ»â€â™‚ï¸ ì»¤ë°‹ ì„±ê³µ."
else
  printf "ğŸ’” swiftlintì— ì–´ê¸‹ë‚˜ëŠ” ì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\n"
  while IFS=':' read -r file_path line_number column_number error_type error_message error_description; do
    icon="ğŸš§"
    if [ "$error_type" = " error" ]; then
      icon="ğŸš¨"
    fi
    echo "$icon$error_type"
    echo "â”— $file_path:$line_number:$column_number"
    echo "â”—$error_message:$error_description"
    echo ""
  done <<< "$lint_result"

  echo "ğŸ™…ğŸ»â€â™‚ï¸ ì»¤ë°‹ ì‹¤íŒ¨. swiftlintì— ë§ê²Œ ì½”ë“œë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”."
  exit 1
fi
