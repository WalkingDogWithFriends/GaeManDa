#!/bin/bash

SWIFTLINT_PATH="$(pwd)/GaeManda/swiftlint"

if [[ -e "${SWIFTLINT_PATH}" ]]; then
	echo "ğŸ” SwiftLint ê²€ì‚¬ ê²½ë¡œ: $(pwd)"
  echo "ğŸš€ SwiftLint ê²€ì‚¬ ì¤‘..."
  echo ""
else
	echo "SwiftLintê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
	exit 1
fi

changed_files=$(git diff --stat --cached)
upstream_branch=$(git for-each-ref --format='%(upstream:short)' $(git symbolic-ref -q HEAD)) 
swift_files=$(git diff --stat --cached --diff-filter=d --name-only $upstream_branch | grep -E "\.swift$")

if [ -n "$changed_files" ] && [ -z "$swift_files" ]; then
  echo "ğŸ™†ğŸ»â€â™‚ï¸ ì»¤ë°‹ ì„±ê³µ."
  exit 0
elif [ -z "$changed_files" ] || [ -z "$swift_files" ]; then
  echo "ğŸ™‹ğŸ»â€â™‚ï¸ ìŠ¤í…Œì´ì§• ì˜ì—­ì— íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
  exit 1
fi

lint_result=$($SWIFTLINT_PATH lint --quiet --config .swiftlint.yml)

echo ""
echo "ğŸš€ swiftlint ê²€ì‚¬ ì™„ë£Œ."

if [ -z "$lint_result" ]; then
	echo "â¤ï¸  ì‘ì„±í•œ ì½”ë“œê°€ SwiftLintì— ë§ìŠµë‹ˆë‹¤."
  echo "ğŸ™†ğŸ»â€â™‚ï¸ ì»¤ë°‹ ì„±ê³µ."
else
	echo ""
	printf "ğŸ’” SwiftLintì— ì–´ê¸‹ë‚˜ëŠ” ì½”ë“œê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\n"

  while IFS=':' read -r file_path \
                        line_number \
                        column_number \
                        error_type \
                        error_message \
                        error_description; do
    icon="ğŸš§"
    if [ "$error_type" = " error" ]; then
      icon="ğŸš¨"
    fi

    echo "$icon$error_type"
    echo "â”— $file_path:$line_number:$column_number"
    echo "â”—$error_message:$error_description"
    echo ""
    
  done <<< "$lint_result"

  echo "ğŸ™…ğŸ»â€â™‚ï¸ ì»¤ë°‹ ì‹¤íŒ¨. SwiftLintì— ë§ê²Œ ì½”ë“œë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”."
  exit 1
fi
